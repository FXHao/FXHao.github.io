---
layout: post
title: "Python 的内存管理"
date: 2019-10-25
description: "python"
tag: 内存管理
---

## Python 的内存管理

* 主要有三个方面：对象引用机制、垃圾回收机制、内存池机制

### 对象引用机制

* Python内部使用引用计数来保持追踪内存中的对象，所有对象都有引用计数
* 引用计数增加的情况：
  * 一个对象分配一个新名称
  * 将其放入一个容器中（如列表，元组或字典）
* 引用计数减少的情况：
  * 使用 del 语句对象别名显示的销毁
  * 引用超出作用域或被重新赋值
* `sys.getrefcount()`函数可以获得对象的当前引用计数
* 多数情况下，引用计数比你猜测得要大得多。对于不可变数据（数字和字符串），解释器会在程序的不同部分共享内存，以便节约内存。

### 垃圾回收

* 当一个对象的引用计数归零时，它将被垃圾收集机制处理掉
* 当两个对象a和对象b相互引用时，del 语句可以减少a和b的引用计数，并销毁用于引用底层对象的名称。然而由于每一个对象都包含一个对其他对象的应用，因此引用计数不会归零，对象也不会销毁。（从而导致内存泄漏）。为解决这一问题，解释器会定期执行一个循环检测器，搜索不可访问对象的循环并删除它们。

### 内存池机制

* python提供了对内存的垃圾收集机制，但是它将不用的内存放到内存池而不是返回给操作系统
  * Pymalloc机制。为了加速python的执行效率，python引入一个内存池机制，用于管理对小块内存的申请和释放
  * python中所有小于256个字节的对象都使用pymalloc实现的分配器，而大的对象则使用系统的malloc
  * 对于python对象，如整数，浮点数和list，都有其独立的私有内存池，对象间不共享它们的内存池。也就是说如果你分配又释放了大量的整数，用于缓存这些整数的内存就不能再分配给浮点数